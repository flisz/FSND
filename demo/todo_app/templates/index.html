<html>
	<head>
		<title> Todo App </title>
		<style>
			.hidden {
				display: none;
			}
			ul {
				list-style: none;
				padding: 0;
				margin: 0;
			}
		</style>
	</head>
	<body>
		<form id="form">
			<div>
				<label for="name">Create a Todo Item:</label>
				<input type="text" id="description" name="description">
			</div>
			<div>
				<input type="submit" value="Create"/>
			</div>
		</form>
		<div id='error' class="hidden"> Something Went Wrong</div>
		<h2>Todos:</h2>
		<ul id="todos">
			{% for item in data %}
				<li><input class="check-completed" type="checkbox" {% if item.completed %} checked {% endif %} data-id="{{ item.id }}"/>{{ item.description }}</li>
			{% endfor %}
		</ul>
	</body>

	<script>
		function sendCompleted(event) {
			console.log('event', event );
			newCompleted = event.target.checked;
			checkboxId = event.target.dataset['id'];
			fetch('/api/todo/completed', {
				method: 'POST',
				body: JSON.stringify(
					{
					'completed': newCompleted,
					'id': checkboxId
					}
				),
				headers: {
					'Content-Type': 'application/json'
				}
			})
			.then(function(response) {
				return response.json()
			})
			.then(function(jsonResponse) {
				console.log(jsonResponse);
			})
		}

		var checkboxes = document.querySelectorAll('.check-completed');
		for (let i = 0; i < checkboxes.length; i++) {
			const checkbox = checkboxes[i];
			checkbox.addEventListener("change", sendCompleted)
		}
		document.getElementById('form').onsubmit = function(e) {
			e.preventDefault();
			fetch('/api/todo/create', {
				method: 'POST',
				body: JSON.stringify({
					'description': document.getElementById('description').value
					}),
					headers: {
						'Content-Type': 'application/json'
						}
					})
					.then(function(response) {
						return response.json()
					})
					.then(function(jsonResponse) {
						console.log(jsonResponse);
						const liItem = document.createElement('LI');
						const newDescription = document.createElement('input');
						newDescription.className = "check-completed";
						newDescription.setAttribute("type", "checkbox");
						newDescription.setAttribute("data-id", jsonResponse['id']);
						newDescription.checked = jsonResponse['completed'];
						console.log(newDescription);
						liItem.appendChild(newDescription);
						liItem.append(jsonResponse['description']);
						document.getElementById('todos').appendChild(liItem);
						document.getElementById('error').className = 'hidden';
						newDescription.addEventListener("change", sendCompleted)
					})
					.catch(function(e) {
						console.log('event', e);
						document.getElementById('error').className = '';
					})
		}
	</script>
</html>
