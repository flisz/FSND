<html>
	<head>
		<title> Todo App </title>
		<style>
			.hidden {
				display: none;
			}
			ul {
				list-style: none;
				padding: 0;
				margin: 0;
			}
		</style>
	</head>
	<body>
		<form id="form">
			<div>
				<label for="name">Create a Todo Item:</label>
				<input type="text" id="description" name="description">
			</div>
			<div>
				<input type="submit" value="Create"/>
			</div>
		</form>
		<div id='error' class="hidden"> Something Went Wrong</div>
		<h2>Todos:</h2>
		<ul id="todos">
			{% for item in data %}
				<li>
					<input class="check-completed" type="checkbox" {% if item.completed %} checked {% endif %} data-id="{{ item.id }}"/>
					{{ item.description }}
					<input type="button" value="Delete" onclick="sendDelete(event)" data-id="{{ item.id }}"/>
				</li>
			{% endfor %}
		</ul>
	</body>

	<script>
		function sendDelete(event) {
			console.log('event', event );
			todoId = event.target.dataset['id'];
			fetch('/api/todo/delete', {
				method: 'POST',
				body: JSON.stringify(
					{
						'id': todoId
					}
				),
				headers: {
					'Content-Type': 'application/json'
				}
			})
			.then(function(response) {
				return response.json()

			})
			.then(function(jsonResponse) {
				liElement = event.target.parentElement
				console.log(jsonResponse);
				console.log('parent', liElement);
				liElement.parentNode.removeChild(liElement)
			})
		}
		
		function sendCompleted(event) {
			console.log('event', event );
			newCompleted = event.target.checked;
			checkboxId = event.target.dataset['id'];
			fetch('/api/todo/completed', {
				method: 'POST',
				body: JSON.stringify(
					{
					'completed': newCompleted,
					'id': checkboxId
					}
				),
				headers: {
					'Content-Type': 'application/json'
				}
			})
			.then(function(response) {
				return response.json()
			})
			.then(function(jsonResponse) {
				console.log(jsonResponse);
			})
		}

		var checkboxes = document.querySelectorAll('.check-completed');
		for (let i = 0; i < checkboxes.length; i++) {
			const checkbox = checkboxes[i];
			checkbox.addEventListener("change", sendCompleted)
		}
		document.getElementById('form').onsubmit = function(e) {
			e.preventDefault();
			fetch('/api/todo/create', {
				method: 'POST',
				body: JSON.stringify({
					'description': document.getElementById('description').value
					}),
					headers: {
						'Content-Type': 'application/json'
						}
					})
					.then(function(response) {
						return response.json()
					})
					.then(function(jsonResponse) {
						console.log(jsonResponse);
						const liItem = document.createElement('LI');
						const newCheckbox = document.createElement('input');
						const newDelete = document.createElement('input');

						newCheckbox.className = "check-completed";
						newCheckbox.setAttribute("type", "checkbox");
						newCheckbox.setAttribute("data-id", jsonResponse['id']);
						newCheckbox.checked = jsonResponse['completed'];
						console.log(newCheckbox);

						newDelete.setAttribute("type", "button");
						newDelete.setAttribute("value", "Delete");
						newDelete.setAttribute("data-id", jsonResponse['id']);
						console.log(newDelete);

						liItem.appendChild(newCheckbox);
						liItem.append(jsonResponse['description']);
						liItem.appendChild(newDelete);

						document.getElementById('todos').appendChild(liItem);
						newCheckbox.addEventListener("change", sendCompleted)
						newDelete.addEventListener("click", sendDelete)
						
						document.getElementById('error').className = 'hidden';
					})
					.catch(function(e) {
						console.log('event', e);
						document.getElementById('error').className = '';
					})
		}
	</script>
</html>
